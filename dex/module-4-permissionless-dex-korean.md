# Module 4: Permissionless DEX (무허가 탈중앙화 거래소)

원문: [https://learnweb3.io/courses/arbitrum-stylus-course/module-4-permissionless-dex/](https://learnweb3.io/courses/arbitrum-stylus-course/module-4-permissionless-dex/)

---

## 강좌 개요

이것은 Arbitrum Stylus 강좌의 Module 4로, Solidity 대신 Rust를 사용하여 더 저렴하고 효율적인 스마트 컨트랙트를 구축하는 방법을 개발자들에게 가르치는 초급 수준의 강좌입니다. 이 모듈에서는 완전한 호환성을 유지하면서 Stylus 프로그래밍 언어를 사용하여 완전히 무허가 방식의 탈중앙화 거래소(DEX)를 구축하는 방법을 다룹니다.

---

## 학습 목표

이 모듈에서는 다음 내용을 다룹니다:

- **자동화된 마켓 메이커(AMM)** 와 **상수 곱 마켓 메이커(CPMM)** 의 작동 원리 이해
- **완전히 무허가 방식의 탈중앙화 거래소**를 처음부터 구축
- 여러 배포된 컨트랙트가 필요한 Stylus 컨트랙트를 위한 **통합 테스트 프레임워크** 생성
- 복잡한 컨트랙트 상호작용을 위한 **엔드투엔드 테스트** 구현

---

## 주요 개념

### AMM 기초

강좌에서는 다음과 같이 설명합니다:

> "자동화된 마켓 메이커는 다른 스타일의 거래소로, 완전히 프로그래밍 방식으로 실행되며 사람들이 서로 직접 거래할 필요가 없습니다."

전통적인 오더북 거래소와 달리, AMM은 유동성 공급자들이 토큰을 예치하는 유동성 풀을 사용하여 거래를 가능하게 합니다. 거래자들은 현재 가격에 따라 이러한 풀과 거래를 합니다.

---

### 상수 곱 공식 (CPMM)

핵심 메커니즘은 다음 공식을 사용합니다:

**x × y = k**

여기서:
- **x**와 **y**는 토큰 수량을 나타냅니다
- **k**는 상수입니다

거래가 발생하면 한 토큰의 양은 증가하고 다른 토큰의 양은 감소하여 상수 곱을 유지합니다.

---

### 계산 예시

10 ETH와 30,000 USDC가 있는 ETH/USDC 풀의 경우:

- 초기 상태: `10 × 30,000 = 300,000 (k)`
- 거래자가 1 ETH를 판매하는 경우
- 새로운 ETH 양: `11 ETH`
- 새로운 USDC 양: `300,000 ÷ 11 ≈ 27,272.73 USDC`
- 거래자가 받는 USDC: `30,000 - 27,272.73 ≈ 2,727.27 USDC`

이는 상수 곱 공식을 기반으로 계산됩니다.

---

## 프로젝트 요구사항

DEX는 다음 기능을 지원해야 합니다:

1. **임의의 두 ERC-20 토큰에 대한 무허가 풀 생성**
2. **유동성 공급** (추가/제거)
3. **임의의 페어 간 토큰 스왑**
4. **유동성 공급자에게 분배되는 수수료 수집**
5. **동일한 토큰 페어에 대한 중복 풀 방지**

---

## 구현 구조

### 스토리지 구성요소

**풀 매핑:**
```
bytes32 → Pool struct
```

**Pool 구조체:**
- 토큰 주소
- 수수료
- 유동성
- 잔액
- 포지션

**Position 구조체:**
- LP 소유권 추적
- 유동성 지분

---

### 에러 처리

다음 시나리오를 위한 커스텀 에러 타입:
- 풀 충돌
- 불충분한 유동성
- 토큰 전송 실패
- 슬리피지 위반

---

### 헬퍼 함수

**`get_pool_id()`**
- Keccak-256 해싱을 사용한 결정론적 풀 ID 계산

**기타 헬퍼 함수들:**
- 풀 상태 조회
- 포지션 관리
- 수수료 계산

---

## 핵심 기능

### 1. `create_pool`
새로운 거래 페어 초기화

### 2. `add_liquidity`
LP가 토큰을 공급할 수 있도록 허용

### 3. `remove_liquidity`
LP 인출 가능

### 4. `swap`
토큰 교환 실행

---

## 개발 환경 설정

새로운 Stylus 프로젝트 생성:

```bash
cargo stylus new dex
```

이후 보일러플레이트 코드를 DEX 구현으로 교체합니다.

---

## 기술 구현 세부사항

### IERC20 인터페이스

토큰 전송을 위한 인터페이스 정의

### 스토리지 구조

컨트랙트는 다음을 정의합니다:
- 풀 매핑 (bytes32 → Pool 구조체)
- 토큰 주소, 수수료, 유동성, 잔액을 포함한 풀 데이터
- 개별 LP 지분을 추적하는 포지션 매핑

---

## 워크플로우 하이라이트

모듈에서는 여러 시나리오 처리를 강조합니다:

1. **초기 유동성 공급**: 비율이 유연함
2. **후속 추가**: 비율 유지 필요
3. **기존 LP를 위한 포지션 추적**

---

## 풀 관리

시스템은 다음을 지원합니다:

- 임의의 토큰 페어에 대한 무허가 풀 생성
- 유동성 공급자 포지션 추적
- 수수료 수집 및 분배
- 거래자를 위한 슬리피지 보호

---

## 유동성 공급 메커니즘

**초기 유동성 공급 시:**
- 비율 설정이 유연함
- 최초 LP가 풀의 가격을 결정

**후속 유동성 추가 시:**
- 기존 풀 비율 유지 필요
- 비례적인 토큰 공급 요구

**유동성 제거:**
- LP는 자신의 지분에 비례하여 토큰 회수
- 포지션 추적을 통한 정확한 분배

---

## 기술 스택

이 구현은 다음을 사용합니다:

- **Rust** - 주요 프로그래밍 언어
- **Stylus SDK** - Arbitrum Stylus 개발 프레임워크
- **Solidity ABI 호환성** - 스마트 컨트랙트 상호작용

---

## 통합 테스트

모듈에서는 다음을 위한 통합 테스트 프레임워크 생성을 다룹니다:

- 여러 배포된 컨트랙트가 필요한 시나리오
- 엔드투엔드 테스트
- 복잡한 컨트랙트 상호작용 검증

---

## 주요 학습 포인트

1. **AMM의 작동 원리** - 프로그래밍 방식의 유동성과 가격 발견
2. **상수 곱 공식** - DEX의 수학적 기초
3. **무허가 시스템** - 누구나 풀을 생성하고 유동성을 공급할 수 있음
4. **수수료 메커니즘** - LP에게 인센티브 제공
5. **슬리피지 보호** - 거래자 보호 메커니즘

---

## 추가 리소스

이 모듈의 전체 내용과 코드 예제는 원문 링크에서 확인하실 수 있습니다:

[https://learnweb3.io/courses/arbitrum-stylus-course/module-4-permissionless-dex/](https://learnweb3.io/courses/arbitrum-stylus-course/module-4-permissionless-dex/)

---

## 결론

이 모듈을 통해 Arbitrum Stylus를 사용하여 완전한 기능을 갖춘 무허가 DEX를 구축하는 방법을 배울 수 있습니다. Rust의 성능과 안전성을 활용하면서도 Ethereum 생태계와의 완전한 호환성을 유지할 수 있습니다.

---

*이 문서는 LearnWeb3의 Arbitrum Stylus Course Module 4를 한글로 번역한 것입니다.*
